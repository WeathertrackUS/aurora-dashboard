name: Deploy Aurora Dashboard

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add Known Hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          TARGET_DIR: "/var/www/aurora"
        run: |
          # 1. Connect and Create Backup
          echo "Creating backup..."
          ssh $VPS_USER@$VPS_HOST "mkdir -p ~/backups && tar -czf ~/backups/backup-$(date +%F-%H%M).tar.gz -C $TARGET_DIR . || echo 'First deploy, skipping backup'"

          # 2. Sync Files (Rsync)
          # We exclude venv (it stays on server), git, and cache
          echo "Syncing files..."
          rsync -avz --delete \
            --exclude '.git*' \
            --exclude 'venv' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude '.env.local' \
            --exclude '*.log' \
            --exclude 'aurora_animations/*.gif' \
            ./ $VPS_USER@$VPS_HOST:$TARGET_DIR/

          # 3. Remote Setup (Install Requirements & Restart)
          echo "Running remote setup..."
          ssh $VPS_USER@$VPS_HOST << 'EOF'
            set -e
            cd /var/www/aurora

            # Create venv if it doesn't exist
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi

            # Update pip and install requirements
            ./venv/bin/pip install --upgrade pip
            if [ -f "requirements.txt" ]; then
              ./venv/bin/pip install -r requirements.txt
            fi

            # Restart the Service
            # Note: We need to allow the robot to do this in sudoers!
            sudo systemctl restart aurora.service
          EOF
